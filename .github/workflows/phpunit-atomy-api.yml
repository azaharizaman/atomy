name: PHP unit tests â€” packages

on:
  push:
    paths:
      - 'packages/**'
  pull_request:
    paths:
      - 'packages/**'

jobs:
  detect-packages:
    name: Detect changed packages
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.find-packages.outputs.packages }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find packages with tests
        id: find-packages
        run: |
          # Find all packages that have both composer.json and phpunit.xml
          PACKAGES=$(find packages -maxdepth 2 -name "phpunit.xml" -exec dirname {} \; | while read pkg; do
            if [ -f "$pkg/composer.json" ]; then
              basename "$pkg"
            fi
          done | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "Found packages: $PACKAGES"

  test-package:
    name: Run tests (${{ matrix.package }})
    needs: detect-packages
    if: needs.detect-packages.outputs.packages != '[]'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.detect-packages.outputs.packages) }}
        php: [8.3]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v3
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, ctype, iconv, pdo_sqlite

      - name: Install Composer
        run: |
          cd packages/${{ matrix.package }}
          composer install --no-interaction --prefer-dist --no-progress

      - name: Run tests
        run: |
          cd packages/${{ matrix.package }}
          if [ -f "phpunit.xml" ] || [ -f "phpunit.xml.dist" ]; then
            vendor/bin/phpunit --testdox
          else
            echo "No phpunit configuration found, skipping tests"
          fi
